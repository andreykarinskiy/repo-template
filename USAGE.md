# Инструкция по использованию шаблона

## Требования

Для работы шаблона необходимо:

- **Git** — система контроля версий
- **Git for Windows** (для Windows) — для работы bash-скриптов в Makefile
- **Python 3.x** — для работы скриптов и установки зависимостей:
  - Скрипт `scripts/version.py` для формирования полной версии
  - Установка `pre-commit` и `commitizen`
- **git-flow** — утилита для работы с GitFlow (входит в состав Git for Windows или устанавливается отдельно)

Проверка наличия зависимостей выполняется автоматически при выполнении `make init`.

## Makefile

Шаблон предоставляет набор универсальных команд через Makefile для управления репозиторием.

### Основные команды

- `make help` — показать список всех доступных команд
- `make init` — инициализировать репозиторий (git init, установка хуков, установка Commitizen)
- `make version` — показать версию репозитория
- `make version-full` — показать полную SemVer-версию с учётом GitFlow и метаданных

### Команды разработки

- `make build` — сборка проекта (требует реализации)
- `make test` — тестирование проекта (требует реализации)
- `make clean` — очистка артефактов сборки проекта (требует реализации)

### Команды Git

- `make commit` — сделать проверяемый коммит через Commitizen (интерактивный режим)
- `make push [REMOTE=origin] [BRANCH=]` — отправить изменения в удаленную ветку. По умолчанию используется текущая ветка и remote `origin`

### Команды GitFlow

Шаблон поддерживает полный цикл работы с GitFlow через команды Makefile. После выполнения `make init` репозиторий готов к работе с GitFlow.

**Требования:**
- Git for Windows (для работы bash-скриптов)
- Установленная утилита `git-flow` (входит в состав Git for Windows или устанавливается отдельно)

#### Feature (фичи)

- `make feature-start <имя>` — начать работу над фичей. Создаёт ветку `feature/<имя>` от `develop`.
  Пример: `make feature-start ISSUE-123-add-login`
  
  **Имена с пробелами:** Для имён фич, содержащих пробелы, используйте переменную окружения:
  ```bash
  FEATURE_NAME="ISSUE-123 add login" make feature-start
  ```
  Или используйте дефисы вместо пробелов: `ISSUE-123-add-login`

- `make feature-finish <имя>` — завершить фичу и смержить в `develop`. Выполняется из ветки `feature/<имя>`.
  Пример: `make feature-finish ISSUE-123-add-login`
  
  **Имена с пробелами:** Аналогично, для имён с пробелами используйте переменную окружения:
  ```bash
  FEATURE_NAME="ISSUE-123 add login" make feature-finish
  ```

**Проверки:**
- `feature-start` можно вызывать только из ветки `develop` при чистом рабочем дереве
- `feature-finish` можно вызывать только из соответствующей ветки `feature/<имя>` при чистом рабочем дереве
- После `feature-finish` выполняется автоматический push в `origin develop`

#### Release (релизы)

- `make release-start` — начать релиз. Создаёт ветку `release/<версия>` от `develop`. Версия берётся из `version.json`.
- `make release-finish` — завершить релиз. Создаёт тег, смерживает в `main`/`master` и `develop`. Выполняется из ветки `release/<версия>`.

**Проверки:**
- `release-start` можно вызывать только из ветки `develop` при чистом рабочем дереве
- Проверяется отсутствие тега с такой версией
- `release-finish` можно вызывать только из соответствующей ветки `release/<версия>` при чистом рабочем дереве
- После `release-finish` выполняется автоматический push всех веток и тегов

#### Hotfix (хотфиксы)

- `make hotfix-start HOTFIX=1.2.1` — начать хотфикс. Создаёт ветку `hotfix/<версия>` от `main`/`master`.
  Пример: `make hotfix-start HOTFIX=1.2.1`
- `make hotfix-finish HOTFIX=1.2.1` — завершить хотфикс. Создаёт тег, смерживает в `main`/`master` и `develop`. Выполняется из ветки `hotfix/<версия>`.

**Проверки:**
- `hotfix-start` можно вызывать только из ветки `main` или `master` при чистом рабочем дереве
- Проверяется отсутствие тега с такой версией
- `hotfix-finish` можно вызывать только из соответствующей ветки `hotfix/<версия>` при чистом рабочем дереве
- После `hotfix-finish` выполняется автоматический push всех веток и тегов

**Примечание:** Команды `build`, `test`, `clean` являются заглушками и должны быть реализованы в конкретном проекте в зависимости от его технологического стека.

## Версионирование (SemVer и GitFlow)

Базовая версия хранится в `version.json`. Управление ею — через Commitizen (bump/tag). Полная версия с пререлизными суффиксами и метаданными сборки формируется автоматически по имени ветки.

### Команды

- `make version` — показать базовую версию (X.Y.Z).
- `make version-full` — показать полную версию с учётом ветки и метаданных (для сборок и отладки).

### Форматы версий по веткам

| Ветка        | Формат полной версии              | Пример |
|-------------|------------------------------------|--------|
| `develop`   | X.Y.Z-alpha.\<N\>+sha.\<hash\>     | 1.3.0-alpha.1+sha.abc123 |
| `release/*` | X.Y.Z-rc.\<N\>+sha.\<hash\>        | 1.3.0-rc.1+sha.ghi789 |
| `hotfix/*`  | X.Y.Z-beta.\<N\>+sha.\<hash\>      | 1.2.1-beta.1+sha.jkl012 |
| `main`/`master` | X.Y.Z+sha.\<hash\> (без пререлиза) | 1.3.0+sha.aaa111 |

Метаданные после `+` — только короткий хеш коммита; не влияют на сравнение версий. Подробнее — в `RULES.md`.

## Commitizen (Conventional Commits)

Шаблон использует [Commitizen](https://commitizen-tools.github.io/commitizen/) для стандартизации сообщений коммитов в формате [Conventional Commits](https://www.conventionalcommits.org/).

### Назначение

Commitizen обеспечивает:
- Единообразный формат сообщений коммитов в проекте
- Автоматическую проверку сообщений через git-хук `commit-msg`
- Удобный интерактивный режим создания коммитов
- Автоматическое управление версией через `cz bump`

### Использование

#### Интерактивный режим (рекомендуется)

Для создания коммита с правильным форматом используйте:

```bash
cz commit
```

Commitizen проведёт вас через интерактивный процесс выбора типа изменения, области (scope), описания и других параметров.

#### Ручное создание коммита

Если вы создаёте коммит вручную, убедитесь, что сообщение соответствует формату:

```
<type>(<scope>): <subject>

<body>

<footer>
```

**Примеры корректных сообщений:**
- `feat: Добавить новую функциональность`
- `fix(config): Исправить ошибку в настройках`
- `docs: Обновить документацию`
- `feat(auth): Добавить аутентификацию пользователей`

**Типы изменений:**
- `feat` — новая функциональность
- `fix` — исправление ошибки
- `docs` — изменения в документации
- `style` — форматирование (без влияния на логику)
- `refactor` — рефакторинг кода
- `perf` — улучшение производительности
- `test` — добавление или изменение тестов
- `build` — сборка или зависимости
- `ci` — изменения в CI/CD
- `chore` — прочие изменения
- `revert` — откат предыдущего коммита

### Автоматическая проверка

Git-хук `commit-msg` автоматически проверяет все коммиты на соответствие формату Conventional Commits. Если сообщение не соответствует формату, коммит будет отклонён с описанием ошибки.

### Управление версией

Для обновления версии в `version.json` используйте:

```bash
cz bump
```

При выполнении `cz bump` Commitizen автоматически обновляет и конфиг (`.cz.toml`), и файл `version.json` — версия остаётся синхронной для Makefile и скриптов. Менять версию вручную не рекомендуется: используйте только `cz bump`.

Commitizen автоматически определит тип изменения (MAJOR/MINOR/PATCH) на основе сообщений коммитов и обновит версию согласно правилам SemVer.

### Changelog

При выполнении `cz bump` Commitizen автоматически обновляет файл `CHANGELOG.md`, добавляя новую версию с перечнем изменений из коммитов. Если файл `CHANGELOG.md` отсутствует, он будет создан автоматически при первом bump.

Файл `CHANGELOG.md` включён в шаблон с начальным содержимым "## Unreleased" и будет скопирован в новый проект при создании из шаблона (если его там ещё нет).

## Примеры использования

### Создание новой фичи

```bash
# Переключиться на develop
git checkout develop

# Создать новую фичу
make feature-start ISSUE-123-add-user-authentication

# Работать над фичей...
# ...

# Закоммитить изменения через Commitizen
make commit

# Завершить фичу и смержить в develop
make feature-finish ISSUE-123-add-user-authentication
```

### Работа с релизами

```bash
# Обновить версию в version.json перед релизом
cz bump

# Начать релиз
make release-start

# Исправить баги, обновить документацию...
# ...

# Завершить релиз
make release-finish
```

### Создание хотфикса

```bash
# Переключиться на main/master
git checkout main

# Создать хотфикс
make hotfix-start HOTFIX=1.2.1

# Исправить проблему...
# ...

# Завершить хотфикс
make hotfix-finish HOTFIX=1.2.1
```

### Проверка версии

```bash
# Базовая версия из version.json
make version

# Полная версия с пререлизом и метаданными
make version-full
```

## Устранение неполадок

### Ошибка: Python не найден

**Проблема:** При выполнении команд Makefile появляется ошибка "Python не найден".

**Решение:**
1. Убедитесь, что Python 3.x установлен на вашей системе
2. Проверьте, что Python добавлен в PATH:
   ```bash
   python --version
   # или
   python3 --version
   ```
3. Если Python не найден, установите его:
   - Windows: скачайте с [python.org](https://www.python.org/downloads/)
   - Linux: `sudo apt-get install python3` (Ubuntu/Debian) или `sudo yum install python3` (CentOS/RHEL)
   - macOS: `brew install python3`

### Ошибка: git-flow не найден

**Проблема:** При выполнении `make init` появляется ошибка "git-flow не найден".

**Решение:**
1. Windows: Git for Windows включает git-flow. Убедитесь, что используете Git for Windows
2. Linux: Установите git-flow:
   ```bash
   sudo apt-get install git-flow  # Ubuntu/Debian
   # или
   brew install git-flow  # macOS
   ```

### Ошибка: Commitizen не найден

**Проблема:** При выполнении `make commit` появляется ошибка "Commitizen не найден".

**Решение:**
```bash
make install-commitizen
```

### Ошибка: Некорректный формат версии

**Проблема:** При чтении `version.json` появляется ошибка о некорректном формате версии.

**Решение:**
1. Убедитесь, что версия в `version.json` соответствует формату SemVer (X.Y.Z)
2. Пример корректного формата:
   ```json
   {"version": "1.2.3"}
   ```
3. Используйте `cz bump` для обновления версии вместо ручного редактирования

### Ошибка: Не удалось определить ветку

**Проблема:** При выполнении `make version-full` появляется предупреждение о невозможности определить ветку.

**Решение:**
1. Убедитесь, что вы находитесь в git-репозитории
2. Проверьте, что есть хотя бы один коммит:
   ```bash
   git log --oneline
   ```
3. Если репозиторий пустой, создайте начальный коммит:
   ```bash
   git commit --allow-empty -m "chore: Initial commit"
   ```

### Ошибка: feature-start можно вызывать только из ветки develop

**Проблема:** При выполнении `make feature-start` появляется ошибка о неправильной ветке.

**Решение:**
1. Переключитесь на ветку develop:
   ```bash
   git checkout develop
   ```
2. Убедитесь, что рабочее дерево чистое (нет незакоммиченных изменений):
   ```bash
   git status
   ```
3. Если есть изменения, закоммитьте их или откатите:
   ```bash
   git stash  # временно сохранить изменения
   # или
   git commit -m "..."  # закоммитить изменения
   ```

### Ошибка: remote 'origin' не найден

**Проблема:** При выполнении `make push` появляется ошибка о отсутствии remote.

**Решение:**
1. Добавьте remote:
   ```bash
   git remote add origin <URL_репозитория>
   ```
2. Или используйте другой remote:
   ```bash
   make push REMOTE=upstream
   ```

### Проблемы с версионированием

**Проблема:** Версия не соответствует ожидаемому формату.

**Решение:**
1. Проверьте формат версии в `version.json`
2. Убедитесь, что используете правильную ветку (develop, release/*, hotfix/*, main/master)
3. Проверьте, что git-репозиторий инициализирован корректно
4. Используйте `make version-full` для проверки полной версии