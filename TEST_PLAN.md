# План тестирования `generic-repo-template`

## 1. Цель

Проверить, что шаблон репозитория корректно:

- создаёт новый проект через Copier;
- инициализирует Git/GitFlow и инструменты контроля коммитов;
- формирует версию по SemVer + GitFlow;
- обеспечивает ожидаемое поведение команд `Makefile`;
- даёт понятные ошибки в некорректных сценариях.

## 2. Область тестирования

Покрываем следующие компоненты:

- `copier.yml`, `PROFILE.yml`, шаблоны `*.jinja`;
- `Makefile` (инициализация, GitFlow-операции, commit/push, версионирование);
- `scripts/version.py`;
- `.pre-commit-config.yaml` и `.cz.toml`;
- артефакты документации, влияющие на пользовательские сценарии (`README.md`, `USAGE.md`).

Не покрываем:

- реализацию `build`, `test`, `clean` (сейчас это заглушки);
- внешние сервисы GitHub/GitLab (только локальная проверка Git-операций).

## 3. Риски и приоритеты

Критичные риски:

- неверная ветка/грязное дерево пропускаются и ломают GitFlow;
- некорректная версия в `version.json` даёт ошибочную сборочную версию;
- неработающий `commit-msg` хук допускает невалидные коммиты;
- `copier` создаёт неполный проект или перезаписывает защищённые файлы.

Приоритеты:

- **P0 (обязательно):** GitFlow-ограничения, `version-full`, commit-msg validation, генерация проекта.
- **P1:** стабильность в сценариях без `origin`, без tracking-ветки, без `.git`.
- **P2:** UX/тексты ошибок, кроссплатформенные нюансы.

## 4. Тестовое окружение

Минимальный набор:

- ОС: Windows 10/11 (Git for Windows), Linux (Ubuntu), macOS;
- Python 3.x;
- Git + git-flow;
- `make` (или совместимый запуск через shell, поддерживаемый в проекте);
- Copier, pre-commit, Commitizen.

Для воспроизводимости:

- каждый сценарий запускать в отдельной временной директории;
- использовать новый локальный git-репозиторий без пользовательских артефактов;
- фиксировать stdout/stderr и код завершения команды.

## 5. Стратегия тестирования

### 5.1 Smoke (после каждого изменения шаблона)

1. Сгенерировать проект через Copier.
2. Выполнить `make init`.
3. Проверить `make version` и `make version-full`.
4. Проверить, что невалидный commit message отклоняется.
5. Проверить `make feature-start` -> `make feature-finish` на чистом репозитории.

### 5.2 Функциональные сценарии

#### A. Генерация проекта (Copier)

- A1: Успешная генерация проекта с дефолтными ответами.
- A2: Корректный рендер `README.md` по `project_name`, `project_description`, `project_tags`.
- A3: Корректный рендер `LICENSE` по `company` и `copyright_year`.
- A4: `USAGE.md`, `PROFILE.yml`, `copier.yml` не копируются в целевой проект (по `_exclude`).
- A5: Файлы из `_skip_if_exists` не перезаписываются при повторном запуске.

#### B. Инициализация и инструменты (`make init`)

- B1: В пустом каталоге создаются git-репозиторий и начальный коммит.
- B2: Создаётся/активируется ветка `develop`.
- B3: Выполняется `git flow init -d`.
- B4: Устанавливается `pre-commit` и `commit-msg` hook.
- B5 (негатив): при отсутствии `git-flow` команда завершается с понятной ошибкой.
- B6 (негатив): при отсутствии Python 3.x команда завершается с понятной ошибкой.

#### C. Версионирование (`make version`, `make version-full`, `scripts/version.py`)

- C1: `make version` возвращает значение из `version.json`.
- C2: `version-full` на `develop` -> `X.Y.Z-alpha.N+sha.<hash>`.
- C3: `version-full` на `release/*` -> `X.Y.Z-rc.N+sha.<hash>`.
- C4: `version-full` на `hotfix/*` -> `X.Y.Z-beta.N+sha.<hash>`.
- C5: `version-full` на `main/master` -> `X.Y.Z+sha.<hash>`.
- C6: при `BUILD_NUMBER=123` используется `N=123`.
- C7 (негатив): некорректный формат версии в `version.json` приводит к ошибке.
- C8: при отсутствии `.git` скрипт возвращает базовую версию.
- C9: при отсутствии `version.json` возвращается `0.0.0` и ненулевой код.

#### D. GitFlow-команды Makefile

- D1: `feature-start` разрешён только из `develop` и при чистом дереве.
- D2: `feature-finish` разрешён только из соответствующей `feature/<name>`.
- D3: `release-start` разрешён только из `develop`, с проверкой отсутствия тега.
- D4: `release-finish` разрешён только из `release/<version>`.
- D5: `hotfix-start` разрешён только из `main/master`, с проверкой отсутствия тега.
- D6: `hotfix-finish` разрешён только из `hotfix/<version>`.
- D7 (негатив): все команды корректно падают вне git-репозитория.
- D8: при отсутствии `origin` команды finish выводят предупреждение и не падают на push.

#### E. Commitizen и проверка коммитов

- E1: валидный Conventional Commit проходит `commit-msg` hook.
- E2: невалидный commit message отклоняется.
- E3: `cz bump` синхронно обновляет `.cz.toml`, `version.json`, `CHANGELOG.md`.
- E4: `make commit` даёт понятную ошибку, если `cz` не установлен.

#### F. Команда `make push`

- F1: по умолчанию пушит текущую ветку в `origin`.
- F2: принимает `REMOTE` и `BRANCH`.
- F3 (негатив): при отсутствующем remote выдаёт список remotes и ошибку.
- F4 (негатив): вне git-репозитория завершается с ошибкой.

### 5.3 Нефункциональные проверки

- NF1: совместимость команд на Windows/Linux/macOS.
- NF2: читаемость и однозначность сообщений об ошибках.
- NF3: устойчивость к пустому/частично настроенному репозиторию.

## 6. Матрица «сценарий -> результат»

- Генерация проекта: все ожидаемые файлы созданы, исключённые/защищённые файлы обработаны корректно.
- Инициализация: создан `develop`, установлен GitFlow, установлен commit-msg hook.
- Версия: формат строго зависит от ветки и соответствует правилам из `RULES.md`.
- GitFlow-команды: нарушенные предусловия всегда блокируют действие.
- Commit policy: только сообщения в формате Conventional Commits проходят.

## 7. Критерии входа/выхода

### Критерии входа

- Актуальная версия шаблона в рабочей ветке.
- Установлены Python, Git, git-flow, Copier.
- Подготовлено чистое временное окружение для прогона.

### Критерии выхода

- Все сценарии P0 успешны.
- Неуспешные сценарии дают предсказуемую ошибку и ненулевой код.
- Для P1 нет блокирующих дефектов.
- Обновлён отчёт о прогоне (что проверено, на каких ОС, какие ограничения остались).

## 8. Автоматизация

Рекомендуемый приоритет автоматизации:

1. `scripts/version.py` (юнит-тесты и параметризованные проверки форматов версий).
2. Интеграционные тесты `Makefile` в временных git-репозиториях.
3. E2E-тест генерации через Copier + smoke `make init`.

Минимальный nightly-набор:

- A1, A4, B1-B5, C1-C7, D1-D7, E1-E3, F1-F4.

## 9. Артефакты тестирования

По результатам каждого прогона фиксировать:

- версию шаблона (commit hash);
- ОС и версии инструментов;
- список выполненных сценариев и статус;
- логи команд (stdout/stderr + exit code);
- найденные дефекты и их приоритет.

## 10. Рекомендации по развитию качества

- Добавить автотесты для `scripts/version.py` и негативных веточных сценариев.
- Перенести проверки ключевых сценариев в CI для каждого PR.
- После реализации `build/test/clean` включить их в smoke и nightly.
